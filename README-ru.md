<p align="center">
  <a href="https://trueconf.com" target="_blank" rel="noopener noreferrer">
    <picture>
      <source media="(prefers-color-scheme: dark)" srcset="https://raw.githubusercontent.com/TrueConf/.github/refs/heads/main/logos/logo-cyrillic-dark.svg">
      <img width="150" alt="trueconf" src="https://raw.githubusercontent.com/TrueConf/.github/refs/heads/main/logos/logo-cyrillic.svg">
    </picture>
  </a>
</p>

<h1 align="center">Создание конференции Труконф на своем сайте в один клик</h1>

<p align="center">Этот проект демонстрирует, как легко интегрировать конференцию на вашем сайте с автоматическим подключением пользователей к конференции</p>

<p align="center">
    <img src="https://img.shields.io/badge/Express.js-%23404d59.svg?logo=express&logoColor=%2361DAFB" />
    <a href="https://t.me/trueconf_talks" target="_blank">
        <img src="https://img.shields.io/badge/Telegram-2CA5E0?logo=telegram&logoColor=white" />
    </a>
</p>

<p align="center">
  <img src="assets/head_ru.png" width="800" height="auto">
</p>

## Описание

**Кейс:** На вашем сайте доктор может пригласить пациента на видеоконференцию, не требуя от него сложных действий. В чате доктор нажимает кнопку **Пригласить в конференцию**, пациенту отображается форма, в которой он вводит своё имя. В один клик создаются гостевая учётная запись и конференция. Пациент автоматически подключается к конференции, не проходя дополнительных шагов.

Как это работает:

1. Доктор и пациент уже авторизованы в системе медицинских услуг (далее — Сайт) и имеют уникальные идентификаторы пользователей (ID), полученные при входе.

> [!TIP]
> В данном примере доктор уже имеет учетную запись в TrueConf Server, поэтому мы можем использовать его TrueConf ID. В реальных кейсах, когда доктор не имеет учетную запись на сервере, ему нужно генерировать TrueConf ID на лету, как это показано ниже примере для пациента.

2. Доктор на Сайте, в ходе общения с пациентом в чате, понимает, что необходимо провести онлайн-встречу. Доктор нажимает кнопку для создания конференции.

3. После этого Сайт отправляет приглашение в чат, в результате чего у пациента отображается форма подключения.

4. Пациент в чате видит форму и заполняет её: вводит своё имя (или оно автоматически подставляется из УЗ при необходимости) и нажимает кнопку **Подключиться**.

5. Скрипт на Cайте автоматически, через API TrueConf Server, создает гостевую учетную запись для пациента, используя его уникальный ID, и запускает новую видеоконференцию.

6. Пациент мгновенно подключается к конференции с указанным именем и уникальным ID.

Таким образом, данный проект демонстрирует интеграцию видеоконференций TrueConf с любым сайтом, обеспечивая быстрый и простой процесс подключения участников, минимизируя дополнительные шаги и упрощая взаимодействие для пользователей.

## Предварительные действия

1. Установите следующие зависимости:

   - Node.js версии 18 или выше;
   - npm версии 9 или выше.

2. Создайте OAuth-приложение на TrueConf Server, следуя инструкциям [здесь](https://trueconf.ru/blog/baza-znaniy/kak-nachat-rabotu-s-trueconf-api) и выдайте приложению право `conferences`.

3. Скопируйте файл `env.sample` и заполните его значениями, соответствующими вашей конфигурации:

```sh
copy env.sample .env   # Для Windows
cp env.sample .env     # Для macOS/Linux
```

4. Отредактируйте файл `.env`, заполнив его следующими значениями:

```env
SERVER=your.trueconf.server          # Адрес вашего сервера TrueConf
CLIENT_ID=generated_client_id       # Идентификатор клиента, полученный при создании OAuth-приложения
CLIENT_SECRET=generated_client_secret  # Секрет клиента, полученный при создании OAuth-приложения
TRUECONF_ID=username_used_as_owner  # Имя пользователя, которое будет использоваться в качестве владельца конференции (доктор)
PORT=3000                            # Опционально: порт, на котором будет работать веб-приложение (по умолчанию 3000)
ALLOW_SELF_SIGNED=false              # Установите true, если используется cамоподписанный TLS-сертификат
```

5. Установите зависимости:

```bash
npm install
```

## Использование

* Для запуска в режиме разработки с автоматической перезагрузкой:

```bash
npm run dev
```

* Для запуска в режиме продакшен:

```bash
npm start
```

> [!TIP]
> Если TrueConf Server использует самоподписанный TLS-сертификат, браузер может блокировать загрузку страницы (в том числе внутри iframe) до тех пор, пока сертификат не будет помечен как доверенный.
>
> Откройте TrueConf Server напрямую в браузере, например https://10.110.2.240, подтвердите предупреждение безопасности и добавьте исключение (или установите сертификат в доверенные). После этого гостевая страница и встраивание через HTTPS будут работать корректно.

Затем перейдите по адресу, указанному в терминале после запуска проекта. По умолчанию — `http://localhost:3000`. В открывшемся окне введите имя пациента. 

Веб-приложение сформирует полезную нагрузку для конференции (включая права доступа, приглашения и другие данные) и отправит её на бэкенд. Бэкенд выполнит следующие шаги:

1. Запросит токен доступа OAuth у вашего сервера TrueConf.

2. Создаст и запустит конференцию, назначив её владельцем доктора, поскольку его TrueConf ID указан в файле `.env` выше.

3. Получит iframe вернет его на фронтенд, который отобразит конференцию в формате веб-приложения на вашем сайте.

## Архитектура фронтенда

- `public/js/conferencePayload.js` — файл, содержащий параметры конференции. Он определяет шаблон прав доступа для участников, а также формирует полезную нагрузку для создания конференции через API, включая такие параметры как название, владельца, описание и права участников.

- `public/js/dom.js` — отвечает за управление состоянием пользовательского интерфейса. В этом файле определены функции для работы с элементами страницы, такими как отображение/скрытие регистрации, рендеринг iframe с видеоконференцией, а также обновление статуса и обработка действий пользователя.

- `public/js/utils.js` — предоставляет вспомогательные функции для обработки ошибок, извлечения и отрисовки iframe с TrueConf Web. Этот файл также включает логику для создания iframe из данных, полученных с сервера.

- `public/js/main.js` — основной файл для управления процессом взаимодействия с сервером и фронтендом. Он получает имя пациента с интерфейса, инициирует запрос для создания конференции на сервере, и по получению ответа с сервера отображает iframe с видеоконференцией в интерфейсе пользователя.

- `public/js/MessageChannel.js` — управляет прослушиванием сообщений от встроенного iframe. Этот файл отслеживает события, такие как выход пользователя из конференции, и выполняет необходимые действия, например, очистку интерфейса и сброс состояния, когда происходит выход из конференции.

## Архитектура бэкенда

Backend построен на `Express.js` и управляется через файл `server.js`. Он взаимодействует с API TrueConf для создания и управления конференциями. Основные компоненты:

1. В файле определяются переменные окружения для подключения к API TrueConf Server через созданное OAuth-приложение;

2. API и маршруты:

   - главная страница (/) отправляет HTML с переменными окружения для фронтенда.
   - маршрут `/api/conference` обрабатывает создание конференции и получение списка подключённых клиентов через API TrueConf Server.

3. Основные функции:

   - `fetchAccessToken()` получает `access_token`;
   - `createTrueConfClient()` создаёт клиента для работы с TrueConf Server API.
   - `createConferenceLifecycle()` создаёт и запускает конференцию.
   - `fetchWebClientClients()` получает список клиентов, подключённых к конференции.

4. Также логируются действия и обрабатываются ошибки.

## Устранение возможных ошибок

- При отсутствии переменных окружения в файле .env в пользовательском интерфейсе будет отображено, какие переменные не были предоставлены.

- В случае ошибок `401` или `403` убедитесь, что идентификатор клиента и секретный ключ принадлежат заданному TrueConf Server.

- При наличии ошибки `400` проверьте, что пользователь с указанным TrueConf ID существует на сервере.

- Если вы столкнулись с таймаутом соединения – убедитесь, что сервер доступен с машины, на которой запущено приложение. Проверьте, установлено ли безопасное соединение с сервером, и убедитесь, что корневой сертификат установлен (либо установите доверие самоподписанным сертификатам).

## Полезные материалы

- [Как начать работу с API TrueConf Server](https://trueconf.ru/blog/baza-znaniy/kak-nachat-rabotu-s-trueconf-api)
- [Автоматическая очистка конференций через TrueConf API](https://trueconf.ru/blog/baza-znaniy/kak-avtomaticheski-ochishhat-zavershivshiesya-konferenczii)
- [Как подключить гостя к конференции напрямую](https://trueconf.ru/blog/baza-znaniy/kak-podklyuchit-gostya-k-konferenczii-napryamuyu)
- [Как управлять TrueConf Server с помощью его API и бота Telegram](https://trueconf.ru/blog/baza-znaniy/kak-upravlyat-trueconf-server-s-pomoshhyu-ego-api-i-bota-telegram)
- [Как использовать TrueConf API для видеозвонков с сайта](https://trueconf.ru/blog/baza-znaniy/kak-ispolzovat-trueconf-api-dlya-videozvonkov-s-sajta)
- [Как добавить виджет с конференцией TrueConf на свой веб-сайт](https://trueconf.ru/blog/baza-znaniy/kak-dobavit-videokonferentsiyu-trueconf-na-svoy-veb-sayt)